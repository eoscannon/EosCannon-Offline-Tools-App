<html>
<head>
    <meta charset="utf-8" />
    <script src="./jquery.min.js"></script>
    <script src="./polyfill.min.js"></script>
    <script src="./eosjs-ecc.min.js"></script>
    <!--<script src="./eos.min.js"></script>-->
    <script>
        window.onload = function() {
            document.addEventListener('message', function(e) {
                var data = JSON.parse(e.data);
                switch (data.method) {
                    case "createPrivateKey" :
                        createPrivateKey();
                        break;
                    case "checkPrivateKey" :
                        checkPrivateKey(data.data);
                        break;
                    case "checkPrivateKeyForAdd" :
                        checkPrivateKeyForAdd(data.data);
                        break;
                    case "signTransaction" :
                        signTransaction(data.data);
                        break;
                    case "signLoginTransaction" :
                        signLoginTransaction(data.data);
                        break;
                    default:
                        responseTestMsg("default");
                }
            });
        };
        function createPrivateKey() {
            var response = {
                method: "createPrivateKey",
                data: {},
            };
            eosjs_ecc.randomKey().then(function(privateKey) {
                response.data.PrivateKey = privateKey;
                response.data.PublicKey = eosjs_ecc.privateToPublic(privateKey);
                window.postMessage(JSON.stringify(response));
            });
        }
        function checkPrivateKey(data) {
            var response = {
                method: "checkPrivateKey",
                data: {},
            };
            response.data.PrivateKey = data.privateKey;
            if (eosjs_ecc.isValidPrivate(data.privateKey) === true) {
                response.data.PublicKey = eosjs_ecc.privateToPublic(data.privateKey)
            } else {
                response.data.PublicKey = "您的私钥不合法，未检测到对应的公钥";
            }
            window.postMessage(JSON.stringify(response));
        }
        function checkPrivateKeyForAdd(data) {
            var response = {
                method: "checkPrivateKeyForAdd",
                data: {},
            };
            if (eosjs_ecc.isValidPrivate(data.privateKey) === true) {
                response.data.IsPrivateKeyValid = true;
            } else {
                response.data.IsPrivateKeyValid = false;
            }
            window.postMessage(JSON.stringify(response));
        }
        function signTransaction(data) {
            var signature = eosjs_ecc.sign(data.UnSignedBuffer, data.PrivateKey, "hex");
            var response = {
                method: "signTransaction",
                data: {
                    signature: signature,
                },
            };
            window.postMessage(JSON.stringify(response));
            // signVerify(signature, data.UnSignedBuffer.actions[0].data, data.PrivateKey);
        }
        function signVerify(signature, data, pk) {
            var PublicKey = eosjs_ecc.privateToPublic(pk);
            var isVerify = eosjs_ecc.verify(signature, data, PublicKey, "hex", false);
            var response = {
                method: "signVerify",
                data: {
                    isVerify: isVerify,
                },
            };
            window.postMessage(JSON.stringify(response));
        }
        function signLoginTransaction(data){
            var time = Math.round(new Date().getTime()/1000);
            var newData = time + data.account + data.UnSignedBuffer + 'wallet';
            var signature = eosjs_ecc.sign(newData, data.PrivateKey);
            var response = {
                method: "signLoginTransaction",
                data: {
                    signature: signature,
                    time:time
                },
            };
            window.postMessage(JSON.stringify(response));
        }
        function responseTestMsg(msg) {
            var response = {
                method: "responseTestMsg",
                data: {
                    msg: msg,
                },
            };
            window.postMessage(JSON.stringify(response));
        }
    </script>
</head>

<body>
</body>
</html>
